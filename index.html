<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RTLS Dashboard</title>
  <link rel="stylesheet" href="styles/styles.css"/>

  <!-- MQTT Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <!-- Scripts -->
  <script src="/data.js"></script>
  <script src="/map.js" defer></script>
</head>

<body>
  <!-- Contenedor para ambos canvases -->
  <div id="canvas-container">
    <canvas id="trajectory-layer"></canvas>
    <canvas id="rtls-dashboard"></canvas>
  </div>

  <!-- Panel lateral derecho -->
  <div id="side-panel">
    <button id="toggle-panel">☰</button>
    <div id="panel-content">

      <h4>Historial por rango</h4>
      <label for="start-time">Desde:</label>
      <input type="datetime-local" id="start-time">

      <label for="end-time">Hasta:</label>
      <input type="datetime-local" id="end-time">

      <label for="device-select">Seleccionar dispositivo(s):</label>
      <select id="device-select" multiple>
        <option value="08B0">08B0</option>
        <option value="D333">D333</option>
      </select>

      <button onclick="handleFetchTrajectory()">Ver trayectoria</button>
      <button onclick ="noWatch()">Detener</button>
      
      <h3>Consultas</h3>

      <div id="quality-control">
        <label for="quality-range">Calidad mínima (%):</label>
        <input 
          type="range" 
          id="quality-range" 
          min="0" 
          max="100" 
          value="50" 
          step="4" 
          oninput="updateQualityThreshold(this.value)">
        <span id="quality-value">50</span>%
      </div>

      <div id="device-info"></div>
    </div>
  </div>

  <!-- Lógica del panel -->
  <script>
    function updateQualityThreshold(value) {
      document.getElementById('quality-value').textContent = value;
      window.setQualityThreshold(Number(value));
    }

    document.getElementById('toggle-panel').addEventListener('click', () => {
      document.getElementById('side-panel').classList.toggle('open');
    });

    function formatDateForPostgres(datetimeLocalValue) {
      return datetimeLocalValue.replace("T", " ") + ":00";
    }

    async function handleFetchTrajectory() {
      const deviceSelect = document.getElementById("device-select");
      const selectedDevices = Array.from(deviceSelect.selectedOptions).map(option => option.value);
      const fromRaw = document.getElementById("start-time").value;
      const toRaw = document.getElementById("end-time").value;
      const from = formatDateForPostgres(fromRaw);
      const to = formatDateForPostgres(toRaw);

      if (selectedDevices.length === 0 || !from || !to) {
        alert("Por favor, selecciona al menos un dispositivo y un rango de tiempo válido.");
        return;
      }

      try {
        const trajectoryCanvas = document.getElementById("trajectory-layer");
        const ctxTrajectory = trajectoryCanvas.getContext("2d");
        ctxTrajectory.clearRect(0, 0, trajectoryCanvas.width, trajectoryCanvas.height);
        window.drawStaticTrajectoryElements(ctxTrajectory); // Updated to use ctxTrajectory

        for (const deviceId of selectedDevices) {
          await window.drawTrajectory(deviceId, from, to);
        }
      } catch (error) {
        console.error("Error al obtener la trayectoria:", error);
      }
    }

    async function noWatch() {
      const trajectoryCanvas = document.getElementById("trajectory-layer");
      trajectoryCanvas.style.zIndex = 0;
      console.log("Stopped watching the trajectory.");
    }
  </script>
</body>
</html>
